---
import { z } from "zod";
import { login } from "../../utils/auth";
export const partial = true;

if (Astro.request.method === "POST") {
  // 1. Get the data and validate it
  const data = await Astro.request.formData();
  const email = String(data.get("email"));
  const password = String(data.get("password"));

  const result = z
    .object({
      email: z
        .string({
          invalid_type_error: "Invalid email",
          required_error: "Email is required",
        })
        .trim()
        .toLowerCase()
        .min(1, "Email is required")
        .email(),
      password: z
        .string({
          invalid_type_error: "Invalid password",
          required_error: "Password is required",
        })
        .min(6, "Password must be atlest 6 digit long"),
    })
    .safeParse({ email, password });

  if (!result.success) {
    return new Response(JSON.stringify(result.error.errors[0].message), {
      status: 200,
      statusText: "Bad Request",
      headers: {
        "HX-Retarget": "#error",
      },
    });
  }

  // 2. Start the login process
  const resp = await login(email, password);

  if (!resp) {
    let response = new Response("User not found", {
      status: 401,
      statusText: "Unauthorized",
      headers: {
        "HX-Retarget": "#error",
      },
    });

    return response;
  }

  Astro.cookies.set("token", resp.token, {
    path: "/",
    httpOnly: true,
  });

  return new Response("Logged in", {
    status: 200,
    statusText: "OK",
    headers: {
      "HX-Redirect": "/",
    },
  });
}
---
